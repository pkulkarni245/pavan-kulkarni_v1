$(document).ready(function(){
    var lastAccess = "unknown";
    var lastIP = "unknown";
    var lastUID = "unknown";
    if(localStorage.lastAccess)
        lastAccess = localStorage.lastAccess;
    if(localStorage.lastIP)
        lastIP = localStorage.lastIP;
    if(localStorage.lastUID)
        lastUID = localStorage.lastUID;
    var deviceName;
    const getUA = () => {
        let device = "Unknown";
        const ua = {
            "Generic Linux": /Linux/i,
            "Android": /Android/i,
            "BlackBerry": /BlackBerry/i,
            "Bluebird": /EF500/i,
            "Chrome OS": /CrOS/i,
            "Datalogic": /DL-AXIS/i,
            "Honeywell": /CT50/i,
            "iPad": /iPad/i,
            "iPhone": /iPhone/i,
            "iPod": /iPod/i,
            "macOS": /Macintosh/i,
            "Windows": /IEMobile|Windows/i,
            "Zebra": /TC70|TC55/i,
        }
        Object.keys(ua).map(v => navigator.userAgent.match(ua[v]) && (device = v));
        return device;
    }
    deviceName= getUA();
    $.getJSON("https://api.ipify.org?format=json", function(data) {
        $.getJSON("http://www.geoplugin.net/json.gp?ip=" + data.ip, function(datadetails){
            var timestamp = new Date().toString();
            var formData = {
                "timestamp": timestamp,
                "ip": data.ip,
                "last_ip" : lastIP,
                "last_access" : lastAccess,
                "last_uid" : lastUID,
                "device": deviceName,
                "ip" : datadetails.geoplugin_request,
                "city" : datadetails.geoplugin_city,
                "continent" : datadetails.geoplugin_continentName,
                "country" : datadetails.geoplugin_countryName,
                "ip_latitude" : datadetails.geoplugin_latitude,
                "ip_longitude" : datadetails.geoplugin_longitude,
                "permission" : "Pre",
                "latitude" : "",
                "longitude" : "",
            }      
            localStorage.setItem("lastIP",data.ip);
            localStorage.setItem("lastAccess",timestamp);
            const firebaseuid = firebase.database().ref('/SiteViews').push(formData).key;
            localStorage.setItem("lastUID", firebaseuid);
        });
    });
    

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(locdata){
            //"latitude" : locdata.coords.latitude,
            //"longitude" : locdata.coords.longitude,
            //"permission" : "Allowed",
        }, function(){
            //"permission" : "Blocked",
        });
    } else {
        //"permission" : "Unsupported",
    }

    
});

/*https://stackoverflow.com/questions/16637035/in-firebase-when-using-push-how-do-i-pull-the-unique-id


To get uniqueID after push() you must use this variant:

// Generate a reference to a new location and add some data using push()
 var newPostRef = postsRef.push();
// Get the unique key generated by push()
var postId = newPostRef.key;
You generate a new Ref when you push() and using .key of this ref you can get uniqueID.


*/